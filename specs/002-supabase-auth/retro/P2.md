# Phase 2 Retrospective: Foundational

## What Worked Well

- **Remote JWT validation via Supabase API** - Simpler than local JWT parsing and handles token revocation automatically
- **Session store with RwLock** - Clean interior mutability pattern for thread-safe access across async tasks
- **Base64-url encoding without padding** - `URL_SAFE_NO_PAD` engine produces 43-char tokens from 32 bytes
- **Privacy compliance testing with custom tracing Layer** - Captures all log output for verification
- **Supabase edge functions** - Straightforward TypeScript with Deno runtime, good for simple endpoints

## What Didn't Work

- N/A - Phase 2 foundational work completed without major issues

## Workarounds & Solutions

- **Token entropy verification** - Using `rand::rng().fill_bytes()` for cryptographically secure random generation
- **Exponential backoff with jitter** - Formula: `min(2^attempt * 100ms + random(0, 100ms), 10s)` for startup retries
- **Wiremock for API mocking** - Essential for testing Supabase client without real network calls

## Packages & Dependencies

**Rust (server):**
- `rand 0.9.0` - Updated API uses `rand::rng()` instead of `thread_rng()`
- `base64 0.22.1` - Use `Engine` trait with `URL_SAFE_NO_PAD` engine
- `wiremock 0.6.2` - Async mock server for HTTP testing
- `tracing-subscriber` - Custom Layer implementation for log capture

**TypeScript (edge function):**
- Deno's native `Deno.serve()` - Built-in HTTP server for edge functions
- `createClient` from `https://esm.sh/@supabase/supabase-js` - CDN-hosted Supabase client

## Patterns & Code

**Session token generation pattern:**
```rust
let mut bytes = [0u8; 32];
rand::rng().fill_bytes(&mut bytes);
URL_SAFE_NO_PAD.encode(bytes) // 43 chars
```

**Privacy-safe logging pattern:**
```rust
debug!(token_len = token.len(), "session token created");
// NOT: debug!(token = %token, "session token created");
```

**Supabase client error mapping:**
- 401 Unauthorized -> Invalid/expired JWT
- Timeout -> 503 Service Unavailable
- Network error -> 503 Unavailable

## For Next Time

- **Test parallelism** - Server tests with env vars must use `--test-threads=1` or `serial_test` crate
- **Grace period placement** - Applied ONLY to WebSocket validation, NOT to token exchange endpoint
- **Edge function environment** - Access service role key via `Deno.env.get()` for database access
