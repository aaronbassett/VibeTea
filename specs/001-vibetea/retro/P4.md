# Phase 4 Retrospective: Monitor Claude Code Watcher (US2)

## What Worked Well

- **Parallel agent execution**: Running watcher.rs and parser.rs implementations in parallel saved significant time
- **notify crate v8**: Clean event-driven API with good documentation
- **Serde's internally tagged enum**: Perfect for parsing Claude Code's `type` field discriminator
- **Position tracking pattern**: HashMap<PathBuf, u64> with RwLock works well for concurrent file tailing

## What Didn't Work

- **Doc example used wrong crate**: Initial doc example referenced `dirs` instead of `directories` crate
- **Parser doc tests ignored**: Many parser doc tests require `ignore` because they parse raw Claude Code JSON that's complex to set up

## Workarounds & Solutions

- **Privacy-first parsing**: Use `#[serde(default)]` and `Option<T>` to gracefully handle missing fields
- **Session ID from filename**: Extract UUID from `.jsonl` filename to use as session identifier
- **Project name from path**: URL decode the slugified path component to get readable project name

## Packages & Dependencies

- **notify 8.x**: Uses `RecommendedWatcher` for cross-platform support
- **percent-encoding 2.3**: For URL decoding project names from file paths
- **directories 5.0**: For cross-platform home directory detection (use `BaseDirs` not `dirs`)

## Patterns & Code

- **WatchEvent enum**: Clean three-variant enum for FileCreated, LinesAdded, FileRemoved
- **SessionParser**: Stateful parser that tracks whether first event has been seen
- **RawClaudeEvent deserialization**: Flat structure with optional nested fields for flexible parsing
- **ParsedEventKind**: Normalized enum that hides Claude Code format complexity

## For Next Time

- Consider adding `notify-debouncer-full` if duplicate events become an issue
- The parser could benefit from streaming deserialization for very large files
