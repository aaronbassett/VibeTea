# Phase 7 Retrospective: Client WebSocket Connection (US5)

## What Worked Well

- **Ref pattern for reconnection**: Using `connectRef` to hold latest `connect` function avoids stale closure issues in recursive reconnection
- **Selective Zustand subscriptions**: Pattern `useEventStore((state) => state.status)` prevents unnecessary re-renders during high-frequency event updates
- **Cross-tab sync**: localStorage `storage` event listener in TokenForm keeps multiple tabs in sync without extra logic
- **Discriminated STATUS_CONFIG**: Record mapping connection status to color/label makes adding new states trivial

## What Didn't Work

- Nothing significant - Phase 7 was straightforward React patterns

## Workarounds & Solutions

- **useCallback dependency array**: Had to split `scheduleReconnect` and `connect` into separate useCallbacks to avoid circular dependencies
- **Type assertion for parsed messages**: Using `parsed as VibeteaEvent` after structural validation is acceptable tradeoff vs full runtime validation

## Packages & Dependencies

- **No new dependencies added**: Used only React 19 built-in hooks (useCallback, useEffect, useRef, useState)
- **Zustand selective subscriptions**: Works well with React 19, no performance issues observed

## Patterns & Code

### WebSocket Reconnection with Refs
```typescript
const connectRef = useRef<() => void>(() => {});
// Update ref when connect changes
useEffect(() => { connectRef.current = connect; }, [connect]);
// Use ref in timeout to avoid stale closure
setTimeout(() => connectRef.current(), delay);
```

### Exponential Backoff with Jitter
```typescript
const exponentialDelay = Math.min(INITIAL_BACKOFF_MS * Math.pow(2, attempt), MAX_BACKOFF_MS);
const jitter = 1 + (Math.random() * 2 - 1) * JITTER_FACTOR; // Â±25%
return Math.round(exponentialDelay * jitter);
```

### Component Status Configuration Map
```typescript
const STATUS_CONFIG: Record<ConnectionStatusType, { color: string; label: string }> = {
  connected: { color: 'bg-green-500', label: 'Connected' },
  // ... other states
};
```

## For Next Time

- Consider extracting reconnection logic into separate hook if other components need similar patterns
- Token validation could be added (checking format before saving) but may be over-engineering for internal use
