# Phase 3 Retrospective: Server Event Hub Core (US1)

## What Worked Well

- **Parallel agent execution**: Running auth.rs, broadcast.rs, and rate_limit.rs implementations in parallel saved significant time
- **axum 0.8 patterns**: The framework's extractors and state management worked cleanly
- **tokio::sync::broadcast**: Perfect fit for the event fan-out pattern
- **ed25519-dalek verify_strict()**: Provides RFC 8032 compliant verification with small-order point rejection

## What Didn't Work

- **Test parallelism with env vars**: Config tests that modify environment variables interfere with each other when run in parallel. Had to use `--test-threads=1` in CI.

## Workarounds & Solutions

- **EnvGuard pattern**: Created a RAII helper to save/restore environment variables during tests
- **Constant-time token comparison**: Used `subtle::ConstantTimeEq` to prevent timing attacks on token validation

## Packages & Dependencies

- **subtle 2.6**: Essential for constant-time comparison to prevent timing attacks
- **futures-util 0.3**: Needed for WebSocket stream handling with `SplitSink`/`SplitStream`
- **tower-http 0.6**: CORS and tracing middleware for axum

## Patterns & Code

- **AppState pattern**: Shared state struct with `Arc<Config>`, `EventBroadcaster`, `RateLimiter`, `Instant`
- **Token bucket rate limiting**: Clean implementation with automatic refill and configurable rate/capacity
- **SubscriberFilter with AND logic**: Builder pattern for optional filters, matches when ALL specified filters match

## For Next Time

- Consider using `serial_test` crate for env var tests instead of global `--test-threads=1`
- WebSocket tests that spawn actual servers work better than mocking for integration testing
