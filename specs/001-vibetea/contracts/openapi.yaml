openapi: 3.1.0
info:
  title: VibeTea Server API
  description: |
    Real-time AI coding assistant activity monitoring server.

    Events are received from Monitors via POST /events and broadcast to Clients via WebSocket at /ws.
  version: 1.0.0
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://vibetea.fly.dev
    description: Production (Fly.io)

paths:
  /events:
    post:
      summary: Ingest events from Monitor
      description: |
        Receives events from authenticated Monitors and broadcasts them to connected WebSocket clients.

        Authentication is via Ed25519 signature. The request body is signed with the Monitor's private key,
        and the server verifies using the registered public key for the source.
      operationId: ingestEvents
      security:
        - monitorAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/Event'
                - type: array
                  items:
                    $ref: '#/components/schemas/Event'
            examples:
              singleEvent:
                summary: Single event
                value:
                  id: evt_k7m2n9p4q1r6s3t8u5v0
                  source: macbook-pro
                  timestamp: "2026-02-02T14:30:00Z"
                  type: tool
                  payload:
                    sessionId: 550e8400-e29b-41d4-a716-446655440000
                    tool: Read
                    status: completed
                    context: main.rs
              batchEvents:
                summary: Batch of events
                value:
                  - id: evt_a1b2c3d4e5f6g7h8i9j0
                    source: macbook-pro
                    timestamp: "2026-02-02T14:30:00Z"
                    type: tool
                    payload:
                      sessionId: 550e8400-e29b-41d4-a716-446655440000
                      tool: Read
                      status: started
                  - id: evt_b2c3d4e5f6g7h8i9j0k1
                    source: macbook-pro
                    timestamp: "2026-02-02T14:30:01Z"
                    type: tool
                    payload:
                      sessionId: 550e8400-e29b-41d4-a716-446655440000
                      tool: Read
                      status: completed
                      context: main.rs
      responses:
        '202':
          description: Events accepted and queued for broadcast
        '400':
          description: Invalid event format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid or missing signature, or unknown source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /ws:
    get:
      summary: WebSocket subscription endpoint
      description: |
        Establishes a WebSocket connection to receive real-time events.

        Authentication is via the `token` query parameter.
        Optional filters can be applied via additional query parameters.

        Once connected, the server pushes JSON-encoded events as text messages.
      operationId: subscribeEvents
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: Subscriber authentication token
        - name: source
          in: query
          required: false
          schema:
            type: string
          description: Filter events by source ID
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [session, activity, tool, agent, summary, error]
          description: Filter events by type
        - name: project
          in: query
          required: false
          schema:
            type: string
          description: Filter events by project name
      responses:
        '101':
          description: WebSocket upgrade successful
        '401':
          description: Invalid or missing token

  /health:
    get:
      summary: Health check endpoint
      description: Returns server health status and connection statistics.
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                connections: 42
                uptime_seconds: 3600

components:
  securitySchemes:
    monitorAuth:
      type: apiKey
      in: header
      name: X-Signature
      description: |
        Ed25519 signature of the request body, base64 encoded.

        The source ID must be provided in the X-Source-ID header.
        The source's public key must be registered in VIBETEA_PUBLIC_KEYS.

  schemas:
    Event:
      type: object
      required:
        - id
        - source
        - timestamp
        - type
        - payload
      properties:
        id:
          type: string
          pattern: ^evt_[a-zA-Z0-9]{20}$
          description: Unique event identifier
          example: evt_k7m2n9p4q1r6s3t8u5v0
        source:
          type: string
          description: Monitor identifier
          example: macbook-pro
        timestamp:
          type: string
          format: date-time
          description: Event timestamp in RFC 3339 UTC format
          example: "2026-02-02T14:30:00Z"
        type:
          type: string
          enum: [session, activity, tool, agent, summary, error]
          description: Event type
        payload:
          $ref: '#/components/schemas/EventPayload'

    EventPayload:
      type: object
      required:
        - sessionId
      properties:
        sessionId:
          type: string
          format: uuid
          description: Session identifier
        project:
          type: string
          description: Project name
        action:
          type: string
          enum: [started, ended]
          description: Session action (for session events)
        tool:
          type: string
          description: Tool name (for tool events)
        status:
          type: string
          enum: [started, completed]
          description: Tool status (for tool events)
        context:
          type: string
          description: File basename or other context
        state:
          type: string
          description: Agent state (for agent events)
        summary:
          type: string
          description: Session summary text (for summary events)
        category:
          type: string
          description: Error category (for error events)

    HealthResponse:
      type: object
      required:
        - status
        - connections
      properties:
        status:
          type: string
          enum: [ok]
        connections:
          type: integer
          description: Number of active WebSocket connections
        uptime_seconds:
          type: integer
          description: Server uptime in seconds

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code for programmatic handling
