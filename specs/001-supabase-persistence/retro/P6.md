# Phase 6 Retrospective: View Historic Activity Heatmap (US1)

## What Worked Well
- **Feature detection pattern**: Using `isPersistenceEnabled()` in a utility module allows components to cleanly return null when feature is disabled
- **Data merging strategy**: Hour-level merging with current hour precedence is simpler than event-level deduplication
- **UTC to local conversion**: `getBucketKeyFromUtc()` cleanly handles the timezone conversion for historic aggregates
- **Non-blocking error states**: Showing error message while still displaying real-time data provides graceful degradation
- **Comprehensive test coverage**: 36 tests covering all edge cases including fake timers for timeout testing

## What Didn't Work
- N/A - Implementation was straightforward building on Phase 5 infrastructure

## Workarounds & Solutions
- **Loading timeout handling**: Used a separate `loadingTimedOut` state rather than trying to derive timeout from status, simplifying the loading/error state machine
- **Test organization**: Created `__tests__/components/` subdirectory to organize component-specific tests separate from hook tests

## Packages & Dependencies
- No new dependencies required
- Existing MSW v2 (`http.get()`, `HttpResponse.json()`) worked well for mocking query endpoint
- Vitest fake timers (`vi.useFakeTimers()`) essential for testing 5-second timeout behavior

## Patterns & Code
- **Feature gate pattern**: Component returns `null` early when feature disabled, avoiding unnecessary hooks/effects
- **Data merging with current hour precedence**:
  ```typescript
  // Historic for past hours, real-time for current hour
  const currentHourKey = getCurrentHourBucketKey();
  for (const aggregate of historicData) {
    const bucketKey = getBucketKeyFromUtc(aggregate.date, aggregate.hour);
    if (bucketKey !== currentHourKey) {
      merged.set(bucketKey, aggregate.eventCount);
    }
  }
  // Real-time always wins for current hour
  merged.set(currentHourKey, realtimeCounts.get(currentHourKey));
  ```
- **Loading timeout with cleanup**: Effect returns cleanup function to prevent state updates after unmount

## For Next Time
- Consider extracting data merging logic to a separate utility if reused elsewhere
- The `vi.useFakeTimers()` pattern is powerful for testing time-dependent behavior - document in TESTING.md
