# Phase 11 Retrospective: Polish & Cross-Cutting Concerns

## What Worked Well
<!-- Effective patterns, tools, approaches -->

### FR-009 Animation Performance Compliance (Verified 2026-02-04)

The dashboard architecture effectively maintains 60fps with the "max 10 concurrent animations" constraint through a layered approach:

1. **CSS-first for ambient effects**: AnimatedBackground uses pure CSS `@keyframes` for grid flicker and particle drift (15 particles max). CSS animations run on the GPU compositor thread, not blocking the main thread.

2. **Explicit throttling for event bursts**: `useAnimationThrottle` hook enforces max 10 entrance animations per second in EventStream via sliding 1-second window timestamp gating.

3. **State-driven glow effects**: Heatmap glow uses inline style updates (`boxShadow`, `filter`) rather than Framer Motion animation instances, keeping animation count low.

4. **Selective animation pausing**: `usePageVisibility` and `useIntersectionObserver` hooks automatically pause background animations when tab is hidden or element is off-screen.

## What Didn't Work
<!-- Problems, issues, limitations encountered -->

## Workarounds & Solutions
<!-- Bug fixes, non-obvious solutions, clever workarounds -->

### Animation Count Management

- **CSS animations vs Framer Motion**: CSS keyframe animations (particles, flicker, pulses) don't count toward concurrent JS animation limits since they run on compositor thread
- **AnimatePresence mode="popLayout"**: Used in SessionOverview to handle session card enter/exit without layout thrashing
- **animatedEventIdsRef tracking**: EventStream tracks which events have already animated via `Set<string>` ref to prevent re-animation on re-render

## Packages & Dependencies
<!-- Useful packages discovered, packages to avoid, version issues -->

### NFR-001 Bundle Size Verification (2026-02-04)

**Constraint**: Animation library additions must be <50KB gzipped

**Result**: COMPLIANT âœ“

| Package | Size (gzipped) | Notes |
|---------|---------------|-------|
| framer-motion (LazyMotion + domAnimation) | ~20KB | Well under 50KB constraint |
| recharts | ~40-50KB | Chart library (separate from animation) |
| @tanstack/react-virtual | ~6KB | Virtual scrolling |

**Overall bundle**: 208KB gzipped total, but this includes React, Recharts, and all application code. The animation library specifically (Motion with LazyMotion) adds only ~20KB.

**Optimization techniques used**:
1. `LazyMotion` with `domAnimation` instead of full `motion` component (~15KB savings)
2. Import `m` component instead of `motion` for tree-shaking
3. domAnimation (~15KB) instead of domMax (~25KB) feature set

## Patterns & Code
<!-- Reusable patterns, helpful code snippets, architectural insights -->

### Animation Throttling Pattern (useAnimationThrottle)

```typescript
// Sliding window throttle for entrance animations
const timestampsRef = useRef<number[]>([]);

const shouldAnimate = useCallback((): boolean => {
  const now = Date.now();
  // Remove timestamps older than 1 second
  timestampsRef.current = timestampsRef.current.filter(t => t > now - 1000);

  if (timestampsRef.current.length >= MAX_ANIMATIONS_PER_SECOND) {
    return false; // Throttled
  }

  timestampsRef.current.push(now);
  return true;
}, []);
```

### Worst-Case Animation Count Analysis

| Component | Type | Max Count | Notes |
|-----------|------|-----------|-------|
| AnimatedBackground | CSS | 15 | Particles, GPU-accelerated |
| SessionOverview | Framer | ~5 | Session cards, bounded by session count |
| Heatmap | Mixed | 1 | Tooltip only for Framer; glow is style updates |
| EventStream | Framer | 10 | Explicitly throttled |
| ConnectionStatus | Framer | 1 | Single indicator |
| Charts (Activity/Distribution) | Recharts | 2 | Built-in transitions |

Normal operation: 5-10 concurrent Framer Motion animations, well under the limit.

## For Next Time
<!-- Improvement suggestions, lessons learned, things to try differently -->

### Animation Performance Monitoring

Consider adding dev-only performance monitoring:
- Animation frame rate tracking via `requestAnimationFrame` timing
- Warning when concurrent animation count exceeds threshold
- React DevTools Profiler integration for render tracking

### CI Workflow Improvements

1. **Lighthouse CI runtime install**: Currently installs `@lhci/cli` at runtime. Consider adding as devDependency for better CI caching.
2. **Storybook artifacts**: Could upload built Storybook as artifact for deployment previews.

### Component Patterns

1. Consider creating a shared `InteractiveButton` component that encapsulates FR-007 (spring hover/focus) compliance by default.
2. The `getEmptyStateMessages()` helper pattern is reusable - could extract to shared utility.

---

## Phase 11 Summary

**Completed**: 2026-02-04

### Tasks Completed
- T238-T241: Phase initialization
- T242-T244: Skeleton loaders and context-aware empty states (FR-016, FR-017)
- T245-T246: Intersection Observer for off-screen animation pause (NFR-005)
- T247-T249: Animation limits (FR-009) and hover/focus compliance (FR-007) verification
- T250-T253: CI workflow enhancements (Lighthouse, Storybook build, reduced-motion check)
- T254-T255: Bundle size verification (NFR-001)
- T256-T259: Documentation updates (quickstart.md, CLAUDE.md)
- T260-T263: Final codebase updates and retro

### Key Deliverables
1. **Skeleton loaders** matching component layouts for initial data fetch
2. **Context-aware empty states** that adapt to connection status
3. **useIntersectionObserver hook** for pausing off-screen animations
4. **Spring-based hover/focus** on all interactive elements
5. **CI enhancements**: Lighthouse, Storybook build, reduced-motion compliance
6. **Documentation** updated with correct versions and patterns
