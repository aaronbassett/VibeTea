# Phase 3 Retrospective: User Story 1 - View Token Usage by Model (P1 MVP)

**Goal**: Track per-model token consumption from stats-cache.json

**Started**: 2026-02-03
**Completed**: 2026-02-03

## Tasks Completed

- [x] T041: Unit test for stats_tracker parsing
- [x] T042: Unit test for TokenUsageEvent emission
- [x] T042A: Unit test for 200ms debounce timing behavior
- [x] T044: Implement StatsCache struct for JSON parsing
- [x] T046: Implement stats_tracker module with file watching
- [x] T048: Implement TokenUsageEvent emission per model
- [x] T050: Add 200ms debounce for stats-cache.json changes
- [x] T052: Add JSON parse failure retry with 100ms delay
- [x] T054: Wire stats_tracker to watcher
- [x] T056: Add client store handler for token_usage events (already supported)

## What Went Well

- StatsTracker is self-contained with its own file watcher, debouncer, and retry logic
- Clean integration with main.rs via separate event channel
- Client already had infrastructure to handle global events (no sessionId)
- 22 unit tests provide good coverage of parsing, debounce, and retry logic

## What Could Be Improved

- Could add integration test to verify end-to-end flow from file change to event emission

## Blockers Encountered

- None

## Critical Learnings

<!-- Items here may be promoted to CLAUDE.md if broadly applicable -->

- StatsTracker uses internal `notify` watcher to watch stats-cache.json (not the JSONL watcher)
- 200ms debounce prevents event flooding during rapid stats updates
- JSON parse retry (100ms delay, 3 attempts) handles mid-write file states
- Client event store handles global events (no sessionId) by just adding to events array

## Notes

- Token usage events are global (not per-session) - they track aggregate model usage
- StatsCache struct matches Claude Code's camelCase JSON format
- ModelTokens has cacheReadInputTokens and cacheCreationInputTokens fields
