# Phase 3 Retrospective: User Story 4 - Secure Edge Functions Handle All Database Access

**Start**: 2026-02-03
**End**: 2026-02-03

## Goals
- Implement edge functions with authentication that mediate all database access
- Wire edge functions to database RPC calls
- Create ingest edge function with Ed25519 signature verification
- Create query edge function with bearer token validation
- Verify RLS denies direct database access (SC-003)

## Tasks Completed
- [x] T037: Create ingest edge function scaffold
- [x] T038: Create query edge function scaffold
- [x] T042: Implement Ed25519 signature verification in ingest
- [x] T043: Implement bearer token validation in query
- [x] T045: Add request body validation to ingest
- [x] T047: Add query parameter validation to query
- [x] T049: Add error response handling to both edge functions
- [x] T051: Wire ingest to database (bulk_insert_events RPC)
- [x] T053: Wire query to database (get_hourly_aggregates RPC)
- [x] T055: Create unit tests for ingest auth
- [x] T056: Create unit tests for query auth
- [x] T058: Create RLS negative test

## Decisions Made

1. **Auth implementation in scaffolds**: T042 and T043 (auth implementations) were completed as part of the scaffold creation (T037-T038). The shared auth utilities (`verifyIngestAuth`, `verifyQueryAuth`) encapsulate all the verification logic, so the edge functions just need to call them and handle the result.

2. **Field name mapping**: JSON uses camelCase (`eventType`), SQL uses snake_case (`event_type`). The `bulk_insert_events` function handles this mapping, and `get_hourly_aggregates` returns snake_case that the edge function maps to camelCase for the API response.

3. **RPC return type handling**: Supabase RPC functions returning `TABLE` produce an array of rows, even for single-row results. Always access `data[0]` after checking array length.

4. **Test environment isolation**: Deno tests use EnvGuard pattern (similar to Rust) for saving/restoring environment variables during tests.

## Issues Encountered

None - Phase 3 completed without major issues.

## Lessons Learned

1. **Deno imports from esm.sh**: Always pin versions (e.g., `@noble/ed25519@2.0.0`) to ensure reproducibility.

2. **Supabase RPC calls**: Use `.rpc('function_name', { param: value })` for calling PostgreSQL functions. Parameters use snake_case to match function signatures.

3. **SECURITY DEFINER functions**: These run with elevated privileges, so grant execute only to `service_role`. RLS is bypassed by design for these functions.

4. **Integration tests**: RLS tests should use `ignore:` flag to skip when environment is not configured, allowing tests to run in CI without real Supabase.

## Critical Learnings for CLAUDE.md

### Supabase Edge Functions (This Phase)
- Deno imports use URL imports from esm.sh with version pinning
- Supabase client initialized with `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` env vars
- RPC functions return arrays; check `data.length` before accessing `data[0]`

These are general patterns already documented in the codebase docs. No critical project-specific learnings require CLAUDE.md update - the existing security patterns from the main codebase (Phase 3 Rust work) remain the most critical.
