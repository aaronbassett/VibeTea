# Phase 5 Retrospective: User Story 3 - Monitor Skill Invocations (P1)

**Goal**: Track skill/slash command invocations from history.jsonl

**Started**: 2026-02-03
**Completed**: 2026-02-04

## Tasks Completed

- [x] T093: Unit test for history.jsonl parsing
- [x] T094: Unit test for shell-like tokenization
- [x] T094A: Unit test for quoted string handling in shell-like tokenizer
- [x] T096: Implement HistoryEntry struct for JSON parsing
- [x] T098: Implement skill_tracker module with file watching
- [x] T100: Implement skill name extraction using shell-like tokenizer
- [x] T102: Wire skill_tracker to watcher
- [x] T104: Add client store handler for skill_invocation events

## What Went Well

- **Reused tokenizer utility**: The shell-like tokenizer from Phase 2 (T022) was well-designed and integrated cleanly with skill_tracker
- **Tail-like file watching**: Using byte offset tracking for append-only files works efficiently without re-reading entire file
- **Comprehensive test coverage**: 75+ unit tests covering parsing, event creation, file watching, and edge cases
- **Privacy-first design**: Only skill names extracted, never command arguments - follows established pattern from agent_tracker

## What Could Be Improved

- **Initial retro template**: Retro file was created with placeholders but not updated during implementation
- **Test isolation**: File watcher tests use timeouts which can be flaky; consider using synchronous test mode

## Blockers Encountered

- None - Phase 5 built on solid foundations from Phase 2 and Phase 4 patterns

## Critical Learnings

<!-- Items here may be promoted to CLAUDE.md if broadly applicable -->

### File Watching for Append-Only Files
- Use byte offset tracking (AtomicU64) for tail-like behavior on append-only JSONL files
- Watch the parent directory, not the file itself, to handle file creation
- Handle file truncation by resetting offset when file_len < current_offset

### Channel Architecture for File Watchers
- notify callbacks run on a separate thread; use mpsc channel to bridge to async tasks
- Spawn async task for event processing, keep watcher callback non-blocking
- Large channel buffer (1000) prevents dropped events during bursts

### No Debounce for Append-Only
- Research showed no debounce needed for history.jsonl (append-only, infrequent writes)
- Contrast with stats-cache.json (Phase 3) which needed 200ms debounce

## Notes

- Skill invocation events track slash command usage from history.jsonl
- Shell-like tokenizer (T022 from Phase 2) extracts skill names
- tokenize.rs utility already implemented in Phase 2
- Pattern follows agent_tracker closely - consistency across tracker modules
