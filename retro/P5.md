# Phase 5 Retrospective: User Story 3 - Client Queries Historic Data

**Start**: 2026-02-03
**End**: 2026-02-04

## Goals
- Client fetches hourly aggregates from query edge function and stores them in Zustand
- Add query integration test verifying aggregation returns HourlyAggregate[]
- Extend EventStore with historicData state
- Implement fetchHistoricData action with bearer token auth
- Create useHistoricData hook with 5-minute stale-while-revalidate caching
- Create MSW handlers for query edge function
- Create unit tests for useHistoricData hook

## Tasks Completed
- [x] T103: Add query integration test verifying aggregation returns HourlyAggregate[]
- [x] T105: Extend EventStore in client/src/store/eventStore.ts with historicData state
- [x] T107: Implement fetchHistoricData action in EventStore with bearer token auth
- [x] T109: Create useHistoricData hook in client/src/hooks/useHistoricData.ts
- [x] T111: Create MSW handlers for query edge function
- [x] T112: Create unit tests for useHistoricData hook

## Decisions Made

### 1. Stale-While-Revalidate Implementation
- Used 5-minute stale threshold (STALE_THRESHOLD_MS = 300,000ms)
- Hook returns cached data immediately while triggering background refresh
- Implemented via useEffect dependency on `historicDataFetchedAt`

### 2. Zustand State Structure for Historic Data
- Added four new state properties to EventStore:
  - `historicData: readonly HourlyAggregate[]`
  - `historicDataStatus: 'idle' | 'loading' | 'error' | 'success'`
  - `historicDataFetchedAt: number | null`
  - `historicDataError: string | null`
- This structure enables proper SWR behavior and error recovery

### 3. Environment Variable Validation
- Both `VITE_SUPABASE_URL` and `VITE_SUPABASE_TOKEN` must be set
- Early validation in `fetchHistoricData` with descriptive error messages
- Graceful degradation: show error state instead of crashing

### 4. MSW Test Setup
- Created `client/src/mocks/` directory with:
  - `data.ts`: Mock factories and error responses
  - `handlers.ts`: Query endpoint handler
  - `server.ts`: MSW server for Vitest
  - `index.ts`: Barrel exports
- Mock token: `"test-bearer-token"` for consistent testing

### 5. Hook Testing Strategy
- Used `@testing-library/react` renderHook for hook testing
- Mocked `fetchHistoricData` via Zustand store setState
- Tested SWR behavior using synchronous state updates
- 23 tests covering all hook functionality

## Issues Encountered

### 1. Tasks.md Out of Sync with Git History
- Discovered that previous session had completed work but tasks.md was not updated
- Required synchronization: committed pending `useHistoricData.ts` and updated tasks.md
- **Resolution**: Always commit tasks.md updates alongside implementation commits

### 2. Vitest Test Environment
- Hook tests require DOM environment (`@vitest-environment happy-dom`)
- MSW v2 uses `http.get()` instead of `rest.get()` from v1
- **Resolution**: Use inline vitest environment pragma in test files

## Lessons Learned

1. **SWR Pattern in Zustand**: The stale-while-revalidate pattern works well with Zustand by:
   - Storing `fetchedAt` timestamp separately from data
   - Using `useEffect` to trigger background refresh when stale
   - Returning cached data immediately while `status === 'loading'`

2. **MSW v2 API Changes**: MSW v2 has significant API differences from v1:
   - Import `http` instead of `rest`
   - Use `HttpResponse.json()` instead of `res(ctx.json())`
   - Handler function receives `{ request, params }` object

3. **Zustand Store Testing**: For testing hooks that use Zustand:
   - Mock store actions with `vi.fn().mockImplementation()`
   - Use `useEventStore.setState()` to set up test state
   - Reset store in `beforeEach` to isolate tests

## Critical Learnings for CLAUDE.md

### MSW v2 Testing Pattern
When testing client code that makes fetch requests, use MSW v2 with this pattern:
```typescript
import { http, HttpResponse } from 'msw';
import { setupServer } from 'msw/node';

const handler = http.get('*/endpoint', ({ request }) => {
  return HttpResponse.json({ data: 'value' }, { status: 200 });
});

const server = setupServer(handler);
```

### Zustand Hook Testing
For testing React hooks that consume Zustand stores:
- Mock store actions rather than the full store
- Use `store.setState()` for synchronous state setup
- Reset store state in `beforeEach` to isolate tests
