# Phase 7 Retrospective: User Story 5 - Track File Edit Line Changes (P2)

**Goal**: Track lines added/removed by diffing consecutive file-history versions

**Started**: 2026-02-04
**Completed**: 2026-02-04

## Tasks Completed

- [x] T148: Unit test for file version parsing (@vN pattern)
- [x] T149: Unit test for line diff calculation
- [x] T150: Unit test for v1 skip behavior
- [x] T152: Add similar crate dependency for line diffs
- [x] T154: Implement FileVersion struct and parsing
- [x] T156: Implement file_history_tracker module with directory watching
- [x] T158: Implement async diff operation for vN vs vN-1
- [x] T160: Implement v1 skip logic (no diff for initial versions)
- [x] T162: Wire file_history_tracker to watcher
- [x] T164: Add 100ms debounce for file-history changes
- [x] T166: Add client store handler for file_change events (already in Phase 1)

## What Went Well

- **TDD with full implementations**: The rust-dev agent wrote comprehensive tests AND working implementations in one pass, reducing iteration cycles
- **Reused existing patterns**: Followed todo_tracker.rs architecture for FileHistoryTracker, making implementation straightforward
- **Comprehensive test coverage**: 72 tests covering parsing, diffing, version logic, and tracker behavior
- **Client types already in place**: Phase 1 added all enhanced tracking types including FileChangePayload
- **Simple diff algorithm**: Using HashMap-based line counting provides accurate results without external diff tools

## What Could Be Improved

- **Task granularity**: T154, T156, T158, T160 were implemented together as the dependencies were tight - separate commits for each wasn't practical
- **Debounce included in tracker**: T164 (debounce) was implemented as part of T156 since they're architecturally coupled
- **Codebase mapping didn't persist**: The sdd:map incremental agents reported success but documents weren't written to disk

## Blockers Encountered

- None - Phase 7 built on solid foundations from previous phases

## Critical Learnings

<!-- Items here may be promoted to CLAUDE.md if broadly applicable -->

### File Version Filename Pattern
- File versions use pattern: `<hash>@v<N>` where hash is exactly 16 hex characters
- Version numbers start at 1, can have leading zeros (e.g., `@v02` = version 2)
- Use `rfind("@v")` to split hash from version, not regular expressions
- Validate hash is exactly 16 hex characters before accepting

### Line Diff Without External Tools
- Simple HashMap-based counting algorithm works well for line diff:
  - Count occurrences of each line in old and new content
  - Lines added = lines in new with higher count than old
  - Lines removed = lines in old with higher count than new
- `lines_modified` approximation: `min(lines_added, lines_removed)`
- No need for external diff crates for basic line counting

### Version Gap Handling
- When version gaps exist (v1, v3 with missing v2), diff against highest available previous version
- Log a warning when gap is detected for debugging
- Search directory for previous versions using `read_dir` and pattern matching

### Session ID from Directory Structure
- File-history structure: `~/.claude/file-history/<session-id>/<hash>@vN`
- Extract session_id from the parent directory name
- Use `path.parent().and_then(|p| p.file_name())` to get session directory

## Notes

- FileChangeEvent emits: session_id, file_hash, version, lines_added, lines_removed, lines_modified, timestamp
- Does NOT use `similar` crate - custom HashMap-based algorithm is sufficient
- File-history uses @vN pattern for versioning (e.g., `3f79c7095dc57fea@v1`, `3f79c7095dc57fea@v2`)
- Skip v1 files - no previous version to diff against (FR-025)
- 100ms debounce for file-history changes (configurable via FileHistoryTrackerConfig)
- 72 unit tests covering parsing, diffing, and tracker functionality
